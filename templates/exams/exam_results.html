{% extends 'base/base.html' %}
{% load exam_filters %}

{% block title %}Exam Results - {{ exam.title }}{% endblock %}

{% block extra_css %}
<style>
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto;
    }
    .score-excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    .score-good {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
        color: white;
    }
    .score-average {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
    }
    .score-poor {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
        color: white;
    }
    .question-review {
        border-left: 4px solid #dee2e6;
        padding-left: 15px;
        margin-bottom: 20px;
    }
    .question-review.correct {
        border-left-color: #28a745;
        background-color: #f8fff9;
    }
    .question-review.incorrect {
        border-left-color: #dc3545;
        background-color: #fff8f8;
    }
    .question-review.partial {
        border-left-color: #ffc107;
        background-color: #fffdf5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Results Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h2 class="mb-3">{{ exam.title }}</h2>
                    <p class="text-muted mb-4">{% if exam.course %}{{ exam.course.name }}{% endif %}</p>
                    
                    <!-- Score Display -->
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="score-circle {% if score >= 90 %}score-excellent{% elif score >= 75 %}score-good{% elif score >= 60 %}score-average{% else %}score-poor{% endif %}">
                                {{ score|floatformat:1 }}%
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="row text-center">
                                <div class="col-6 col-md-3">
                                    <h5 class="text-success mb-1">{{ correct_answers }}</h5>
                                    <small class="text-muted">Correct</small>
                                </div>
                                <div class="col-6 col-md-3">
                                    <h5 class="text-danger mb-1">{{ incorrect_answers }}</h5>
                                    <small class="text-muted">Incorrect</small>
                                </div>
                                <div class="col-6 col-md-3">
                                    <h5 class="text-warning mb-1">{{ partial_answers }}</h5>
                                    <small class="text-muted">Partial</small>
                                </div>
                                <div class="col-6 col-md-3">
                                    <h5 class="text-secondary mb-1">{{ total_questions }}</h5>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Exam Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Exam Details
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6"><strong>Started:</strong></div>
                        <div class="col-6">{{ session.start_time|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Completed:</strong></div>
                        <div class="col-6">{{ session.end_time|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Duration:</strong></div>
                        <div class="col-6">{{ session.start_time|duration_format:session.end_time }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Status:</strong></div>
                        <div class="col-6">
                            <span class="badge bg-success">Completed</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Performance Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Overall Score</span>
                            <span>{{ score|floatformat:1 }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if score >= 90 %}bg-success{% elif score >= 75 %}bg-info{% elif score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 data-width="{{ score }}"></div>
                        </div>
                    </div>
                    
                    {% if score >= 90 %}
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-trophy me-2"></i>
                            Excellent performance! Outstanding work.
                        </div>
                    {% elif score >= 75 %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-thumbs-up me-2"></i>
                            Good job! Well done on this exam.
                        </div>
                    {% elif score >= 60 %}
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            You passed! Consider reviewing the material.
                        </div>
                    {% else %}
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-times-circle me-2"></i>
                            You didn't pass. Please review and try again.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Question Review -->
    {% if show_answers %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list-alt me-2"></i>
                        Question Review
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#questionReview">
                        <i class="fas fa-eye me-1"></i>Show/Hide
                    </button>
                </div>
                <div class="collapse" id="questionReview">
                    <div class="card-body">
                        {% for question, user_answer, is_correct, points_earned in question_results %}
                        <div class="question-review {% if is_correct == 'correct' %}correct{% elif is_correct == 'incorrect' %}incorrect{% else %}partial{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">Question {{ forloop.counter }}</h6>
                                <div class="text-end">
                                    <span class="badge {% if is_correct == 'correct' %}bg-success{% elif is_correct == 'incorrect' %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ points_earned }}/{{ question.points }} points
                                    </span>
                                </div>
                            </div>
                            
                            <p class="mb-2">{{ question.question_text }}</p>
                            
                            {% if question.question_type == 'multiple_choice' or question.question_type == 'true_false' %}
                                <div class="mb-2">
                                    <strong>Your Answer:</strong> 
                                    <span class="{% if is_correct == 'correct' %}text-success{% else %}text-danger{% endif %}">
                                        {{ user_answer|default:"Not answered" }}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <strong>Correct Answer:</strong> 
                                    <span class="text-success">{{ question.correct_answer }}</span>
                                </div>
                            {% else %}
                                <div class="mb-2">
                                    <strong>Your Answer:</strong>
                                    <div class="border rounded p-2 mt-1">
                                        {{ user_answer|default:"Not answered" }}
                                    </div>
                                </div>
                                {% if question.correct_answer %}
                                <div class="mb-2">
                                    <strong>Sample Answer:</strong>
                                    <div class="border rounded p-2 mt-1 bg-light">
                                        {{ question.correct_answer }}
                                    </div>
                                </div>
                                {% endif %}
                            {% endif %}
                            
                            {% if question.explanation %}
                            <div class="mt-2">
                                <strong>Explanation:</strong>
                                <div class="text-muted mt-1">{{ question.explanation }}</div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Actions -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'authentication:dashboard' %}" class="btn btn-primary me-2">
                <i class="fas fa-home me-1"></i>
                Back to Dashboard
            </a>
            {% if exam.allow_retake and score < exam.passing_score %}
            <a href="{% url 'exams:take_exam' exam.id %}" class="btn btn-outline-warning">
                <i class="fas fa-redo me-1"></i>
                Retake Exam
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths from data attributes
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
});
</script>
{% endblock %}